<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results Page</title>
    <script src="https://unpkg.com/react/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-white text-gray-800">
    <div class="p-8" id="root"></div>
    <script type="text/babel">
        function SearchResults() {
            const [query, setQuery] = React.useState(new URLSearchParams(window.location.search).get('query') || '');
            const [searchResults, setSearchResults] = React.useState([]);
            const [aiAnswer, setAiAnswer] = React.useState('');
            const [memeImage, setMemeImage] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            React.useEffect(() => {
                if (query) {
                    handleSearch(query);
                }
            }, [query]);

            const handleSearch = async (searchQuery) => {
                if (loading) return;
                setLoading(true);
                try {
                    // Fetch search results from /api/rag-search
                    const searchResponse = await fetch('/api/rag-search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: searchQuery }),
                    });
                    const searchData = await searchResponse.json();
                    setSearchResults(searchData);

                    // Fetch AI answer from /api/chat
                    const chatResponse = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ context: searchData, query: searchQuery }),
                    });
                    const chatData = await chatResponse.json();
                    setAiAnswer(chatData.answer);

                    // Generate meme from /api/meme-generator
                    const memeResponse = await fetch('/api/meme-generator', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topic: searchQuery }),
                    });
                    const memeBlob = await memeResponse.blob();
                    setMemeImage(URL.createObjectURL(memeBlob));
                } catch (error) {
                    console.error('Error:', error);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container mx-auto p-4">
                    <header className="mb-4">
                        <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-lg p-2 w-full max-w-2xl flex space-x-2">
                            <input
                                type="text"
                                value={query}
                                onChange={(e) => setQuery(e.target.value)}
                                placeholder="Woof woof ... "
                                className="input input-bordered flex-grow p-2 border rounded-lg"
                                onKeyPress={(e) => e.key === 'Enter' && handleSearch(query)}
                            />
                            <button
                                className={`btn btn-primary p-2 bg-blue-500 text-white rounded-lg ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                disabled={loading}
                                onClick={() => handleSearch(query)}
                            >
                                Go
                            </button>
                        </div>
                    </header>
                    <main className="flex space-x-4">
                        <section className="w-full sm:w-7/12">
                            <div className="mb-4 p-4 border rounded-lg bg-gray-100">
                                <h2 className="text-2xl font-bold mb-2">Answer：</h2>
                                <p>{aiAnswer}</p>
                            </div>
                            <div className="mb-4 p-4 border rounded-lg bg-gray-100">
                                <h2 className="text-2xl font-bold mb-2">Meme Image：</h2>
                                {memeImage && <img src={memeImage} alt="Generated Meme" className="rounded shadow max-w-full h-auto" />}
                            </div>
                        </section>
                        <section className="w-full sm:w-5/12">
                            <h2 className="text-2xl font-bold mb-4">Reference：</h2>
                            {searchResults.map((result, index) => (
                                <div key={index} className="mb-2 p-2 border rounded-lg hover:bg-gray-200">
                                    <h3 className="text-lg font-semibold">{result.title}</h3>
                                    <p>{result.snippet}</p>
                                </div>
                            ))}
                        </section>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<SearchResults />, document.getElementById('root'));
    </script>
</body>
</html>